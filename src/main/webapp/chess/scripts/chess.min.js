function initDragDrop(){for(var e=0;e<64;e++){$("#square_"+e).children("img").draggable({addClasses:false},{containment:"#chess-container"},{revert:"invalid"})}}function destroyAllDragDrop(){for(var e=0;e<64;e++){if($("#square_"+e).children("img").length!=0&&$("#square_"+e).children("img").draggable().length!=0){$("#square_"+e).children("img").draggable("destroy")}if($("#square_"+e).droppable()){$("#square_"+e).droppable("destroy")}}}function updateDragDrop(e,t){t=t.replace(/\[/g,"").replace(/\]/g,"").split(",");$(e).droppable({addClasses:false},{accept:function(e){for(var n in t){if(direction){dragFrom=63-parseInt(t[n].replace(/^\s+|\s+$/g,""));if("square_"+dragFrom==$(e).parent().attr("id")){return true}}else{if("square_"+t[n].replace(/^\s+|\s+$/g,"")==$(e).parent().attr("id")){return true}}}}},{drop:function(t,n){var r=$(n.draggable).parent().attr("id").substring(7);var i=e.substring(8);var s=$(e).children("img");if(s.length==0){var o=r-i;if(o==7||o==9||o==-7||o==-9){if($(n.draggable).hasClass("wpawn")){s=$("#square_"+(parseInt(i)+8)).children("img");s.remove()}else if($(n.draggable).hasClass("bpawn")){s=$("#square_"+(parseInt(i)-8)).children("img");s.remove()}}}else{s.remove()}var u=$(this);u.append(n.draggable);var a=u.width();var f=u.height();var l=a/2-n.draggable.width()/2;var c=f/2-n.draggable.height()/2+2;if(n.draggable.hasClass("wpawn")||n.draggable.hasClass("bpawn")){l-=10}else{l-=4}n.draggable.css({left:l+"px",top:c+"px"});if($(n.draggable).hasClass("wking")||$(n.draggable).hasClass("bking")){if(direction){if(r==3&&i==1){$("#square_2").append($("#square_0").children("img"))}else if(r==3&&i==5){$("#square_4").append($("#square_7").children("img"))}else if(r==59&&i==57){$("#square_58").append($("#square_56").children("img"))}else if(r==59&&i==61){$("#square_60").append($("#square_63").children("img"))}}else{if(r==60&&i==62){$("#square_61").append($("#square_63").children("img"))}else if(r==60&&i==58){$("#square_59").append($("#square_56").children("img"))}else if(r==4&&i==6){$("#square_5").append($("#square_7").children("img"))}else if(r==4&&i==2){$("#square_3").append($("#square_0").children("img"))}}}if(direction){r=63-parseInt(r);i=63-parseInt(i)}if($(n.draggable).hasClass("wpawn")&&r>=8&&r<=15){openPromotionWindow("white",r,i)}else if($(n.draggable).hasClass("bpawn")&&r>=48&&r<=55){openPromotionWindow("black",r,i)}else{playMove(r,i,EMPTY)}}})}function trim(e){if(e==null){return""}return e.replace(/^\s*/g,"").replace(/\s*$/g,"")}function newGame(e,t){if(e==undefined){fen="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"}else{fen=e}if(!t){direction=false}$("#white_promotion_window").css({visibility:"hidden"});$("#black_promotion_window").css({visibility:"hidden"});for(var n=0;n<=63;n++){piece=$("#square_"+n).children("img");if(piece.length!=0){piece.remove()}}var r=trim(fen).split("\\s+");var i=r[0].split("/");var n,s;for(var o=0;o<8;o++){var u=0;for(var a=0;a<i[o].length;a++){n=o*8+u;if(direction){n=63-n}s=$("#square_"+n);var f=i[o].charAt(a);if(!/(^\d\d*$)/.test(f)){u++}switch(f){case"p":s.append(bpawn);break;case"n":s.append(bknight);break;case"b":s.append(bbishop);break;case"r":s.append(brook);break;case"q":s.append(bqueen);break;case"k":s.append(bking);break;case"P":s.append(wpawn);break;case"N":s.append(wknight);break;case"B":s.append(wbishop);break;case"R":s.append(wrook);break;case"Q":s.append(wqueen);break;case"K":s.append(wking);break;default:u+=parseInt(f)}}}if(t){return}destroyAllDragDrop();thinkingMode=true;var l=new Date;var c="engine/init.htm?epoch="+l.getMilliseconds();$.getJSON(c,{fen:fen},function(e){var t=e.dragDrop.split(separator);var n=t[0];fen=t[1];pgnMoves=t[2];n=n.replace(/\{/g,"").replace(/\}/g,"").split("=");initDragDrop();var i=null;for(var s in n){r=n[s].split(",");key=r[r.length-1];if(i!=null){if(r.length>1&&s<n.length-1){values=r.splice(0,r.length-1)}else{values=r}if(direction){updateDragDrop("#square_"+(63-parseInt(i)),values.join(","))}else{updateDragDrop("#square_"+i,values.join(","))}}i=trim(key)}thinkingMode=false})}function openPromotionWindow(e,t,n){for(var r=0;r<64;r++){if($("#square_"+r).children("img").draggable()){$("#square_"+r).children("img").draggable("disable")}}pawnFromSq=t;promotedSq=n;if(e=="white"){$("#white_promotion_window").css({visibility:"visible"})}else{$("#black_promotion_window").css({visibility:"visible"})}}function playMove(e,t,n){if(n!=EMPTY){$("#white_promotion_window").css({visibility:"hidden"});$("#black_promotion_window").css({visibility:"hidden"});for(var r=0;r<64;r++){if($("#square_"+r).children("img").draggable()){$("#square_"+r).children("img").draggable("enable")}}}destroyAllDragDrop();thinkingMode=true;var i=new Date;var s="engine/drag_drop.htm?epoch="+i.getMilliseconds();$.getJSON(s,{fromSq:e,toSq:t,promotedPiece:n,fen:fen},function(e){var t=e.dragDrop.split(separator);var n=t[1];var r=t[2];fen=t[3];var i=t[4];pgnMoves=t[5];makeCompMove(r);if(trim(i)!=""){alert(i);thinkingMode=false;return}initDragDrop();n=n.replace(/\{/g,"").replace(/\}/g,"").split("=");var s=null;for(var o in n){arr=n[o].split(",");key=arr[arr.length-1];if(s!=null){if(arr.length>1){values=arr.splice(0,arr.length-1)}else{values=arr}if(direction){updateDragDrop("#square_"+(63-parseInt(s)),values.join(","))}else{updateDragDrop("#square_"+s,values.join(","))}}s=trim(key)}thinkingMode=false})}function makeCompMove(e){var t=e>>>12&7;var n=e&63;var r=e>>>6&63;var i=e>>>18&7;if(direction){n=63-n;r=63-r}var s=$("#square_"+n).children("img");var o=$("#square_"+r).children("img");if(o.length==0){sqDiff=n-r;if(t==PAWN&&(sqDiff==7||sqDiff==9||sqDiff==-7||sqDiff==-9)){if(s.hasClass("wpawn")!=direction){o=$("#square_"+(r+8)).children("img")}else{o=$("#square_"+(r-8)).children("img")}o.remove()}}else{o.remove()}if(i==EMPTY){$("#square_"+r).append(s)}else{if(s.hasClass("wpawn")){s.remove();if(i==QUEEN){$("#square_"+r).append(wqueen)}else if(i==KNIGHT){$("#square_"+r).append(wknight)}else if(i==ROOK){$("#square_"+r).append(wrook)}else if(i==BISHOP){$("#square_"+r).append(wbishop)}}else{s.remove();if(i==QUEEN){$("#square_"+r).append(bqueen)}else if(i==KNIGHT){$("#square_"+r).append(bknight)}else if(i==ROOK){$("#square_"+r).append(brook)}else if(i==BISHOP){$("#square_"+r).append(bbishop)}}}if(t==KING){if(direction){if(n==3&&r==1){s=$("#square_0").children("img");$("#square_2").append(s)}else if(n==3&&r==5){s=$("#square_7").children("img");$("#square_4").append(s)}else if(n==59&&r==57){s=$("#square_56").children("img");$("#square_58").append(s)}else if(n==59&&r==61){s=$("#square_63").children("img");$("#square_60").append(s)}}else{if(n==60&&r==62){s=$("#square_63").children("img");$("#square_61").append(s)}else if(n==60&&r==58){s=$("#square_56").children("img");$("#square_59").append(s)}else if(n==4&&r==6){s=$("#square_7").children("img");$("#square_5").append(s)}else if(n==4&&r==2){s=$("#square_0").children("img");$("#square_3").append(s)}}}}function switchSides(){if(thinkingMode){return}direction=!direction;newGame(fen,true);destroyAllDragDrop();thinkingMode=true;var e=new Date;var t="engine/play.htm?epoch="+e.getMilliseconds();$.getJSON(t,{fen:fen},function(e){var t=e.dragDrop.split(separator);var n=t[0];var r=t[1];fen=t[2];var i=t[3];pgnMoves=t[4];makeCompMove(r);if(trim(i)!=""){alert(i);thinkingMode=false;return}initDragDrop();n=n.replace(/\{/g,"").replace(/\}/g,"").split("=");var s=null;for(var o in n){arr=n[o].split(",");key=arr[arr.length-1];if(s!=null){if(arr.length>1){values=arr.splice(0,arr.length-1)}else{values=arr}if(direction){updateDragDrop("#square_"+(63-parseInt(s)),values.join(","))}else{updateDragDrop("#square_"+s,values.join(","))}}s=trim(key)}thinkingMode=false})}function takebackMove(){alert("lol takeback is not allowed, my dear friend")}$(document).ready(function(){newGame(fen,false);$("#WQ").click(function(){$("#square_"+promotedSq).children("img").remove();$("#square_"+promotedSq).append(wqueen);playMove(pawnFromSq,promotedSq,QUEEN)});$("#WR").click(function(){$("#square_"+promotedSq).children("img").remove();$("#square_"+promotedSq).append(wrook);playMove(pawnFromSq,promotedSq,ROOK)});$("#WB").click(function(){$("#square_"+promotedSq).children("img").remove();$("#square_"+promotedSq).append(wbishop);playMove(pawnFromSq,promotedSq,BISHOP)});$("#WN").click(function(){$("#square_"+promotedSq).children("img").remove();$("#square_"+promotedSq).append(wknight);playMove(pawnFromSq,promotedSq,KNIGHT)});$("#BQ").click(function(){$("#square_"+promotedSq).children("img").remove();$("#square_"+promotedSq).append(bqueen);playMove(pawnFromSq,promotedSq,QUEEN)});$("#BR").click(function(){$("#square_"+promotedSq).children("img").remove();$("#square_"+promotedSq).append(brook);playMove(pawnFromSq,promotedSq,ROOK)});$("#BB").click(function(){$("#square_"+promotedSq).children("img").remove();$("#square_"+promotedSq).append(bbishop);playMove(pawnFromSq,promotedSq,BISHOP)});$("#BN").click(function(){$("#square_"+promotedSq).children("img").remove();$("#square_"+promotedSq).append(bknight);playMove(pawnFromSq,promotedSq,KNIGHT)})});var fen="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";var separator="XXX";var direction=false;var thinkingMode=false;var moveList;var wking="<img src='images/WK.png' class='wking'>";var wqueen="<img src='images/WQ.png' class='wqueen'>";var wrook="<img src='images/WR.png' class='wrook'>";var wbishop="<img src='images/WB.png' class='wbishop'>";var wknight="<img src='images/WN.png' class='wknight'>";var wpawn="<img src='images/WP.png' class='wpawn'>";var bking="<img src='images/BK.png' class='bking'>";var bqueen="<img src='images/BQ.png' class='bqueen'>";var brook="<img src='images/BR.png' class='brook'>";var bbishop="<img src='images/BB.png' class='bbishop'>";var bknight="<img src='images/BN.png' class='bknight'>";var bpawn="<img src='images/BP.png' class='bpawn'>";var EMPTY=0;var ROOK=1;var KNIGHT=2;var BISHOP=3;var QUEEN=4;var KING=5;var PAWN=6;var pawnFromSq,promotedSq